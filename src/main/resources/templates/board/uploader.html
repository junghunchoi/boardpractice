<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" th:href="@{/css/read.css}" type="text/css">
  <link rel="stylesheet" th:href="@{/css/uploader.css}" type="text/css">
</head>
<body>
<div class="uploader-main">
  <div style="display: flex; flex-direction: column; align-items:center">
    <input type="hidden" id="hiddeneditorinput" name="content"/>
    <div id="uploaderArea">
      <div id="fileUploader" th:if="${files != null and not #lists.isEmpty(files)}">
        <table>
          <thead>
          <tr>
            <th></th>
            <th>Filename</th>
          </tr>
          </thead>
          <tbody class="tb_files">
          <tr th:each="files : ${files}">
            <td><input type="checkbox" name="fileCheckbox" th:value="${files.filename}"></td>
            <td th:text="${files.filename}"></td>
          </tr>
          </tbody>
        </table>
      </div>
      <!-- 파일 목록이 존재하지 않는 경우 파일 업로더 표시 -->
      <div id="fileUploader" th:unless="${files != null and not #lists.isEmpty(files)}">
        파일을 끌어다 놓으세요
      </div>
    </div>
  </div>
</div>
<!--<script th:src="@{/js/read.js}"></script>-->
<script>
  const $uploaderArea = document.querySelector("#uploaderArea");

  window.addEventListener('message', function (e) {
    let url = e.data.url;
    if (url === "/board/read") {
      const $button = document.createElement("button");
      $button.innerText = "다운로드";
      $button.type = "button";
      $button.id = "button_download";
      $button.onclick = filesDownload;
      $uploaderArea.after($button, $uploaderArea.firstChild);
    } else {//register, update
      const $uploaderArea = document.querySelector("#uploaderArea");
      var divElement = document.createElement('div');
      divElement.className = 'append-btn';

      var labelElement = document.createElement('label');
      labelElement.textContent = '파일추가';

      var inputElement = document.createElement('input');
      inputElement.type = 'file';
      inputElement.multiple = true;
      inputElement.id = 'fileAddBtn';
      inputElement.name = 'file';
      inputElement.style.display = 'none';

      labelElement.appendChild(inputElement);
      divElement.appendChild(labelElement);

      $uploaderArea.after(divElement, $uploaderArea.firstChild);
    }
  })

  function filesDownload() {
    return fetch('http://10.10.0.157:1234/download', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        fileList: getCheckedFileList(),
      }),
    })
    .then((response) => response.blob())
    .then((blob) => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'files.zip';
      document.body.appendChild(a);
      a.click();
      a.remove();
    })
    .catch((error) => console.error('Error fetching files:', error));
  }

  function getCheckedFileList() {
    var checkboxes = document.querySelectorAll(".fileList input[type='checkbox']");
    var checked = [];
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].checked) {
        checked.push(checkboxes[i].defaultValue);
      }
    }
    return checked;
  }
</script>
</body>
</html>